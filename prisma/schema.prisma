// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
  ACCOUNTANT
}

enum SubscriptionPlan {
  FREE
  BASIC
  STANDARD
  PRO
  ENTERPRISE
}

model Tenant {
  id            String         @id @default(cuid())
  name          String
  domain        String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  users         User[]
  subscriptions Subscription[]
  branches      Branch[]

  products Product[]

  customers Customer[]

  suppliers Supplier[]

  purchases Purchase[]

  sales Sale[]

  expenses Expense[]

  auditLogs AuditLog[]
}

model User {
  id        String     @id @default(cuid())
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  name      String
  email     String     @unique
  password  String
  roles     UserRole[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  auditLogs AuditLog[]
}

model RoleEntity {
  id    String     @id @default(cuid())
  name  Role
  users UserRole[]
}

model UserRole {
  id     String     @id @default(cuid())
  user   User       @relation(fields: [userId], references: [id])
  userId String
  role   RoleEntity @relation(fields: [roleId], references: [id])
  roleId String
}

model Subscription {
  id        String           @id @default(cuid())
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  tenantId  String
  plan      SubscriptionPlan
  status    String           @default("active") // active, canceled, trial
  startDate DateTime         @default(now())
  endDate   DateTime?
  stripeId  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model Branch {
  id        String    @id @default(cuid())
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  tenantId  String
  name      String
  location  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
  sales     Sale[]
}

model Product {
  id          String           @id @default(cuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  branchId    String?
  branch      Branch?          @relation(fields: [branchId], references: [id])
  name        String
  sku         String?          @unique
  description String?
  price       Float
  stock       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  variants    ProductVariant[]
  sales       SaleItem[]
}

model ProductVariant {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  name      String
  sku       String?  @unique
  price     Float
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  email     String?  @unique
  phone     String?
  credit    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sales     Sale[]
}

model Supplier {
  id        String     @id @default(cuid())
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  purchases Purchase[]
}

model Purchase {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  supplierId  String
  totalAmount Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Sale {
  id          String     @id @default(cuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  customerId  String?
  customer    Customer?  @relation(fields: [customerId], references: [id])
  totalAmount Float
  paymentType String
  status      String     @default("completed") // completed, refunded
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  items       SaleItem[]
}

model SaleItem {
  id        String   @id @default(cuid())
  sale      Sale     @relation(fields: [saleId], references: [id])
  saleId    String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  quantity  Int
  price     Float
  discount  Float?   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Expense {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  category    String
  amount      Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  entity     String
  entityId   String
  beforeData Json?
  afterData  Json?
  createdAt  DateTime @default(now())
}
